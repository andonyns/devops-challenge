pipeline {
	agent any
	environment {
		TF_DIR = "${WORKSPACE}/terraform"
	}
	stages {
        stage('Checkout code') {
            steps {
                git url: 'https://github.com/andonyns/devops-challenge', branch: 'main'
            }
        }

		stage('Checkov') {
			steps {
				dir('terraform') {
					sh 'pipenv run pip install checkov'
					sh 'pipenv run checkov -d . -o cli -o junitxml --output-file-path console,results.xml'
				}
			}
		}
		stage('Terraform Init') {
			steps {
				dir('terraform') {
					sh 'terraform init'
				}
			}
		}

		stage('Terraform Plan') {
			steps {
				dir('terraform') {
					sh 'terraform plan'
				}
			}
		}
	}
}
